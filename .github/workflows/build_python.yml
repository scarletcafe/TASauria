name: Build TASauria Python package

on:
  push:
  pull_request:
    types: [ opened, edited ]
  workflow_dispatch:

jobs:
  build-dists:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
        python:
          - {version: '3.9'}
          - {version: '3.10'}
          - {version: '3.11'}
          - {version: '3.12'}
          - {version: '3.13'}
    name: "${{ matrix.os }} CPython ${{ matrix.python.version }}"
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python.version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python.version }}

    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip setuptools wheel

        pip install -U -r requirements.txt

        pip install -U ruff

    - name: Lint repository
      shell: bash
      run: |
        ruff check ./tasauria

    - name: Create distributions and install wheel
      shell: bash
      run: |
        export tag_name="${GITHUB_REF##*/}"

        # Substitute README assets with direct GitHub links
        sed -i'.original' -e "s/src=\".github\/assets/src=\"https:\/\/raw.githubusercontent.com\/scarletcafe\/TASauria\/$(git rev-parse HEAD)\/.github\/assets/g" README.md
        rm -f README.md.original

        python ./setup.py sdist bdist_wheel

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tasauria_python_${{ matrix.os }}-${{ matrix.python.version }}
        path: dist/*

  upload_pypi:
    needs: [ build-dists ]
    runs-on: ubuntu-latest
    environment: publish
    permissions:
      # Required to create release
      contents: write
      # Required for OIDC
      id-token: write
    if: github.event_name == 'push' && startsWith(github.event.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'  # Watch as I let this get handled as a float again

      - name: Install dependencies
        shell: bash
        run: |
          sudo apt-get update && sudo apt-get install -y hub
          python -m pip install --upgrade pip setuptools wheel
          export tag_name="${GITHUB_REF##*/}"
          pip install -U "."
          pip install -U jinja2

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: tasauria_python_ubuntu-latest-3.13
          merge-multiple: true
          path: dist

      - name: Publish wheels as release artifacts on GitHub
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x
          export tag_name="${GITHUB_REF##*/}"
          python .github/scripts/create_dist_summary.py
          assets=()
          for asset in ./dist/*.{whl,tar.gz}; do
            assets+=("-a" "$asset")
          done
          tag_name="${GITHUB_REF##*/}"
          hub release create "${assets[@]}" -F .github/outputs/DIST_SUMMARY.md "$tag_name"
          rm .github/outputs/*.md

      - name: Publish packages to PyPI
        uses: pypa/gh-action-pypi-publish@v1.13.0
